{% extends "base.html" %}
{% load static %}
{% block title %}Checkout - Dulcis Fabula{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="mb-4">Checkout</h1>

    {% if items %}<<
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Dati di spedizione</h4>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        {{ form.non_field_errors }}
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="id_first_name" class="form-label">Nome*</label>
                                <input type="text" class="form-control" id="id_first_name" name="first_name" required>
                            </div>
                            <div class="col-md-6">
                                <label for="id_last_name" class="form-label">Cognome*</label>
                                <input type="text" class="form-control" id="id_last_name" name="last_name" required>
                            </div>
                            
                            <div class="col-12">
                                <label for="id_email" class="form-label">Email*</label>
                                <input type="email" class="form-control" id="id_email" name="email" required>
                            </div>
                            
                            <div class="col-12">
                                <label for="id_phone" class="form-label">Telefono*</label>
                                <input type="tel" class="form-control" id="id_phone" name="phone" required>
                            </div>
                            
                            <div class="col-12">
                                <label for="id_address" class="form-label">Indirizzo*</label>
                                <input type="text" class="form-control" id="id_address" name="address" required>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="id_postal_code" class="form-label">CAP*</label>
                                <input type="text" class="form-control" id="id_postal_code" name="postal_code" pattern="\d{5}" required>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="id_city" class="form-label">Città*</label>
                                <input type="text" class="form-control" id="id_city" name="city" required>
                            </div>
                            
                            <div class="col-md-2">
                                <label for="id_province" class="form-label">Provincia*</label>
                                <select class="form-select" id="id_province" name="province" required>
                                    <option value=""> </option>
                                    <option value="AG">AG</option>
                                    <option value="AL">AL</option>
                                    <option value="AN">AN</option>
                                    <option value="AO">AO</option>
                                    <option value="AR">AR</option>
                                    <option value="AP">AP</option>
                                    <option value="AT">AT</option>
                                    <option value="AV">AV</option>
                                    <option value="BA">BA</option>
                                    <option value="BT">BT</option>
                                    <option value="BL">BL</option>
                                    <option value="BN">BN</option>
                                    <option value="BG">BG</option>
                                    <option value="BI">BI</option>
                                    <option value="BO">BO</option>
                                    <option value="BZ">BZ</option>
                                    <option value="BS">BS</option>
                                    <option value="BR">BR</option>
                                    <option value="CA">CA</option>
                                    <option value="CL">CL</option>
                                    <option value="CB">CB</option>
                                    <option value="CI">CI</option>
                                    <option value="CE">CE</option>
                                    <option value="CT">CT</option>
                                    <option value="CZ">CZ</option>
                                    <option value="CH">CH</option>
                                    <option value="CO">CO</option>
                                    <option value="CS">CS</option>
                                    <option value="CR">CR</option>
                                    <option value="KR">KR</option>
                                    <option value="CN">CN</option>
                                    <option value="EN">EN</option>
                                    <option value="FM">FM</option>
                                    <option value="FE">FE</option>
                                    <option value="FI">FI</option>
                                    <option value="FG">FG</option>
                                    <option value="FC">FC</option>
                                    <option value="FR">FR</option>
                                    <option value="GE">GE</option>
                                    <option value="GO">GO</option>
                                    <option value="GR">GR</option>
                                    <option value="IM">IM</option>
                                    <option value="IS">IS</option>
                                    <option value="SP">SP</option>
                                    <option value="AQ">AQ</option>
                                    <option value="LT">LT</option>
                                    <option value="LE">LE</option>
                                    <option value="LC">LC</option>
                                    <option value="LI">LI</option>
                                    <option value="LO">LO</option>
                                    <option value="LU">LU</option>
                                    <option value="MC">MC</option>
                                    <option value="MN">MN</option>
                                    <option value="MS">MS</option>
                                    <option value="MT">MT</option>
                                    <option value="ME">ME</option>
                                    <option value="MI">MI</option>
                                    <option value="MO">MO</option>
                                    <option value="MB">MB</option>
                                    <option value="NA">NA</option>
                                    <option value="NO">NO</option>
                                    <option value="NU">NU</option>
                                    <option value="OT">OT</option>
                                    <option value="OR">OR</option>
                                    <option value="PD">PD</option>
                                    <option value="PA">PA</option>
                                    <option value="PR">PR</option>
                                    <option value="PV">PV</option>
                                    <option value="PG">PG</option>
                                    <option value="PU">PU</option>
                                    <option value="PE">PE</option>
                                    <option value="PC">PC</option>
                                    <option value="PI">PI</option>
                                    <option value="PT">PT</option>
                                    <option value="PN">PN</option>
                                    <option value="PZ">PZ</option>
                                    <option value="PO">PO</option>
                                    <option value="RG">RG</option>
                                    <option value="RA">RA</option>
                                    <option value="RC">RC</option>
                                    <option value="RE">RE</option>
                                    <option value="RI">RI</option>
                                    <option value="RN">RN</option>
                                    <option value="RO">RO</option>
                                    <option value="SA">SA</option>
                                    <option value="SS">SS</option>
                                    <option value="SV">SV</option>
                                    <option value="SI">SI</option>
                                    <option value="SR">SR</option>
                                    <option value="SO">SO</option>
                                    <option value="TA">TA</option>
                                    <option value="TE">TE</option>
                                    <option value="TR">TR</option>
                                    <option value="TO">TO</option>
                                    <option value="TP">TP</option>
                                    <option value="TN">TN</option>
                                    <option value="TV">TV</option>
                                    <option value="TS">TS</option>
                                    <option value="UD">UD</option>
                                    <option value="VA">VA</option>
                                    <option value="VE">VE</option>
                                    <option value="VB">VB</option>
                                    <option value="VC">VC</option>
                                    <option value="VR">VR</option>
                                    <option value="VV">VV</option>
                                    <option value="VI">VI</option>
                                    <option value="VT">VT</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="id_country" class="form-label">Paese*</label>
                                <select class="form-select" id="id_country" name="country" required>
                                    <option value="IT" selected>Italia</option>
                                </select>
                            </div>
                            
                            <div class="col-12">
                                <label for="id_notes" class="form-label">Note per la consegna (opzionale)</label>
                                <textarea class="form-control" id="id_notes" name="notes" rows="2" placeholder="Es. Citofono Rossi, cancello blu..."></textarea>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Pagamento</h4>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="cc-name" class="form-label">Nome sulla carta</label>
                            <input type="text" class="form-control" id="cc-name" placeholder="" required>
                            <div class="invalid-feedback">
                                Il nome sulla carta è richiesto.
                            </div>
                        </div>

                        <div class="col-12">
                            <label for="cc-number" class="form-label">Numero carta di credito</label>
                            <input type="text" class="form-control" id="cc-number" placeholder="" required>
                            <div class="invalid-feedback">
                                Il numero della carta è richiesto.
                            </div>
                        </div>

                        <div class="col-md-3">
                            <label for="cc-expiration" class="form-label">Scadenza</label>
                            <input type="text" class="form-control" id="cc-expiration" placeholder="MM/AA" required>
                            <div class="invalid-feedback">
                                Data di scadenza richiesta.
                            </div>
                        </div>

                        <div class="col-md-3">
                            <label for="cc-cvv" class="form-label">CVV</label>
                            <input type="text" class="form-control" id="cc-cvv" placeholder="" required>
                            <div class="invalid-feedback">
                                Codice di sicurezza richiesto.
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 mt-4">
                  <button type="submit" class="btn btn-primary w-100 py-2">Paga ora</button>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-light">
                    <h4 class="mb-0">Riepilogo ordine</h4>
                </div>
                <div class="card-body">
                    <ul class="list-group mb-3">
                        {% for item in items %}
                        <li class="list-group-item">
                            <div class="row align-items-center">
                                <div class="col-3">
                                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" 
                                         class="img-fluid rounded" style="max-height: 80px;">
                                </div>
                                <div class="col-9">
                                    <h6 class="my-0">{{ item.product.name }}</h6>
                                    <small class="text-muted">
                                        Quantità: {{ item.quantity }} × €{{ item.product.price }}
                                    </small>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>

                    <div class="border-top pt-3">
                        <div class="d-flex justify-content-between mb-1">
                            <span>Subtotale:</span>
                            <span>€{{ subtotal|floatformat:2 }}</span>
                        </div>
                        {% if discount > 0 %}
                        <div class="d-flex justify-content-between mb-1 text-danger">
                            <span>Sconto:</span>
                            <span>-€{{ discount|floatformat:2 }}</span>
                        </div>
                        {% endif %}
                        <div class="d-flex justify-content-between mb-1">
                            <span>Spedizione:</span>
                            <span>€{{ shipping_cost|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mt-3 fw-bold fs-5">
                            <span>TOTALE:</span>
                            <span>€{{ total|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="alert alert-info" role="alert">
        Il tuo carrello è vuoto. <a href="{% url 'shop:product_list' %}" class="alert-link">Continua lo shopping</a>.
    </div>
    {% endif %}
</div>
{% endblock %}